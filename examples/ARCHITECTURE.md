# Examples Architecture

## TL;DR

**For ESP32-C6 or any embedded target:**
```bash
cd examples/dpp-esp32c6
cargo build --release
```

**The workspace example (`cargo build --example dpp`) will NOT work for embedded.**

---

## Why Two Directory Structures?

### 1. Workspace Examples (`examples/dpp.rs`)

**Purpose**: Source reference and future native examples

**Structure**:
```
examples/
├── Cargo.toml          # Workspace member
├── dpp.rs              # Source code
└── .cargo/config.toml
```

**Status**: ❌ Does NOT link for embedded targets

**Reason**: Missing essential embedded infrastructure:
- `memory.x` (RAM/Flash layout)
- `link.x` (linker script from esp-hal)
- Interrupt vector definitions
- Build.rs that generates platform code
- Symbol definitions (ets_delay_us, etc.)

**Future Use**:
- Native examples (Linux, Windows, macOS) with `std`
- QEMU simulation
- Reference implementation

### 2. Standalone Projects (`examples/dpp-esp32c6/`)

**Purpose**: Complete, flashable embedded projects

**Structure**:
```
examples/dpp-esp32c6/
├── Cargo.toml          # Standalone package (NOT workspace member)
├── .cargo/config.toml  # RISC-V target config
├── src/
│   └── main.rs         # Application code
└── build.rs            # Auto-generated by esp-hal
```

**Status**: ✅ Fully functional, can build and flash

**Why It Works**:
- esp-hal's build.rs generates memory.x and link.x
- Complete interrupt vector setup
- All required symbols defined
- Proper no_std embedded setup

---

## Build Commands Summary

### ❌ DON'T DO THIS (Will Fail)
```bash
# These commands will produce linker errors:
cargo build --example dpp --features esp32c6 -p qp-examples
cd examples && cargo build --example dpp --features esp32c6
```

**Error**: `undefined symbol: ets_delay_us, __stack_chk_guard, interrupt29, etc.`

### ✅ DO THIS INSTEAD
```bash
# Build for ESP32-C6:
cd examples/dpp-esp32c6
cargo build --release

# Flash to hardware:
espflash flash --monitor target/riscv32imac-unknown-none-elf/release/dpp-esp32c6
```

---

## Why Keep Both?

1. **Workspace Example (dpp.rs)**:
   - Clean, single-file reference
   - Shows QP framework usage without board-specific noise
   - Will enable future native examples with minimal changes
   - Demonstrates feature-based platform selection pattern

2. **Standalone Project (dpp-esp32c6/)**:
   - Actually works for embedded targets
   - Can be flashed to real hardware
   - Has all necessary build infrastructure
   - Follows esp-hal ecosystem patterns

---

## Adding New Platforms

### For Embedded Targets (STM32, nRF52, etc.)

Create a new standalone project:

```bash
mkdir examples/dpp-stm32f4
cd examples/dpp-stm32f4
# Create Cargo.toml with platform HAL
# Copy and adapt src/main.rs
# Ensure .cargo/config.toml has correct target
```

Add to workspace exclude list:
```toml
# In root Cargo.toml
exclude = [
    "examples/blinky",
    "examples/dpp-esp32c6",
    "examples/dpp-stm32f4",  # New!
]
```

### For Native Targets (Linux, Windows)

Use the workspace example with a new feature:

1. Add feature to `examples/Cargo.toml`:
   ```toml
   [features]
   linux = ["dep:std"]
   ```

2. Update `dpp.rs`:
   ```rust
   #[cfg(feature = "linux")]
   fn main() {
       // Native implementation with std
   }
   ```

3. Build:
   ```bash
   cargo build --example dpp --features linux -p qp-examples
   ```

---

## Frequently Asked Questions

**Q: Why not make the workspace example work for embedded?**

A: It's not possible without duplicating all the build infrastructure (memory.x, link.x, build.rs) that HAL crates provide. The standalone project approach is the standard pattern in the Rust embedded ecosystem.

**Q: Can I delete the workspace examples directory?**

A: Keep it! It will be useful for native examples and serves as a clean reference implementation.

**Q: Will this improve in the future?**

A: Possibly, if Rust embedded tooling evolves to support better workspace integration. For now, standalone projects are the standard approach (see embassy, esp-hal examples, etc.).

---

## References

This architecture follows established patterns in the Rust embedded ecosystem:
- [esp-rs/esp-hal](https://github.com/esp-rs/esp-hal) - Examples are standalone
- [embassy-rs/embassy](https://github.com/embassy-rs/embassy) - Examples are standalone
- [rust-embedded/awesome-embedded-rust](https://github.com/rust-embedded/awesome-embedded-rust)
